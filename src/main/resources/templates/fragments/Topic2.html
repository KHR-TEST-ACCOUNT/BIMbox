<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<body>
	<div th:fragment="topic(topic)" th:remove="tag">
	<!-- トピック -->
		<div class="mt-3 ">
			<div class="d-flex justify-content-between bg-light bg-light topic">
				<h5 th:text="${topic.subject}">トピックのタイトル</h5>
				
				<form id="deleteForm" th:action="@{/comms/deleteTopic.do}" method="post" th:object="${ topicSearchForm }">
					<input type="hidden" name="topicNo" th:value="${topic.topicNo}" />
					<div th:if="${topic.isOwnedBy(user)}">
						<button id="topoicDelete" class="btn btn-link p-0 text-dark fs-5" title="トピック削除">
							<i class="bi bi-trash"></i>
						</button>
					</div>
				</form>
				
			</div>
			
			<!-- 投稿一覧 -->
			<div id="posts">
				<div class="bg-light p-3 posts post" th:each="post : ${topic.posts}">
					<div class="d-flex border-bottom">
						<div class="me-3">
							<a th:href="|@{/profile/UserProfile.html}?id=${post.author.id}|">
								<img class="userImg" th:src="${ post.author.profileImage.encodedString }"/>
							</a>
						</div>
						
						<!-- post content -->
						<div class="flex-grow-1">
							<!-- rateByUser に各 Ratings を格納 -->
							<form id="ratingForm" th:action="@{/comms/PostRating.do}" method="post" 
								th:with="rateByUser=${post.getRateByUser(user)}" th:object="${ topicSearchForm }">
								
								<div class="d-flex justify-content-between">
									<p class="fw-bold" th:text="${post.author.username}">投稿者の名前</p>
									<!-- 投稿編集 NG -->
									<div th:if="${post.isPostedBy(user)}">
										<button id="postEdit" type="button" title="投稿編集" class="btn btn-link p-0 text-dark fs-5"
												th:data-ts-target="|#${topic.topicNo + post.postNo}|">
											<i class="bi bi-pencil-square"></i>
										</button>
									</div>
								</div>
								
								<!-- IMG NG-->
								<div th:if="${ post.postImg }">
									<img class="postImg" th:src="${ post.postImg.encodedString }" />
								</div>
								<textarea class="form-control text-dark readonly p-0" readonly th:text="${post.postText}" name="postText" id="postText"></textarea>
								
								<div class="py-2 d-flex justify-content-end d-none" th:if="${post.isPostedBy(user)}" th:id="${(topic.topicNo) + (post.postNo)}">
									<!-- update -->
									<button id="textEdit" type="button" class="btn btn-success btn-sm me-2 shadow-sm">編集</button>
									<!-- 投稿削除 NG-->
									<button th:if="${topic.posts.size() > 1}" id="textDelete" type="button" class="btn btn-secondary btn-sm me-2 shadow-sm">削除</button>
								</div>
								
								<input type="hidden" name="topicNo" th:value="${topic.topicNo}" />
								<input type="hidden" name="postNo" th:value="${post.postNo}" />
								
								<div class="d-flex justify-content-end py-2">
									<!-- 高評価 NG-->
									<div class="d-flex align-items-baseline me-3">
										<button type="button" class="btn btn-link p-0 me-2 text-dark fs-5 ajax-link" 
												th:data-ts-param="1" th:disabled="${post.isPostedBy(user)}">
											<th:block th:if="!${rateByUser.rater}">
												<i class="bi bi-hand-thumbs-up"></i>
											</th:block>
											<th:block th:if="${rateByUser.rater}">
												<div th:unless="${rateByUser.rater.id == user.id && rateByUser.rating gt 0 }">
													<i class="bi bi-hand-thumbs-up"></i>
												</div>								 
												<div th:if="${rateByUser.rater.id == user.id && rateByUser.rating gt 0 }">
													<i class="bi bi-hand-thumbs-up-fill"></i>
												</div>	
											</th:block>							 
										</button>
										<span th:text="${rateByUser.goodRatings.size()}">13</span>
									</div>
									<!-- 低評価 -->
									<!-- 
									<div class="d-flex align-items-baseline me-3">
										<button type="button" class="btn btn-link p-0 me-2 text-dark fs-5 ajax-link"
											th:data-ts-param="-1" th:disabled="${post.isPostedBy(user)}">
											<th:block th:if="!${rateByUser.rater}">
												<i class="bi bi-hand-thumbs-down"></i>
											</th:block>
											<th:block th:if="${rateByUser.rater}">
												<div th:unless="${rateByUser.rater.id == user.id && rateByUser.rating lt 0 }">
													<i class="bi bi-hand-thumbs-down"></i>
												</div>								 
												<div th:if="${rateByUser.rater.id == user.id && rateByUser.rating lt 0 }">
													<i class="bi bi-hand-thumbs-down-fill"></i>
												</div>				
											</th:block>				 
										</button>
										<span th:text="${rateByUser.badRatings.size()}">2</span>
									</div>
									 -->
									<!-- 最初のtopicのみ、post数を表示 -->
									<div class="d-flex align-items-baseline"
										th:classappend="${post.isFirstPost() ? '' : 'd-none'}">
										<span class="me-2 text-dark fs-5">
											<i class="bi bi-chat"></i>
										</span>
										<span th:text="${topic.posts.size() - 1}">post count</span>
									</div>
								</div>
							</form>
						</div>
						<!-- end -->
						
					</div>
				</div>
				<!-- 新規投稿 -->
				<div class="d-flex bg-light p-3 post newPost">
					<div class="me-3">
						<a th:href="|@{/profile/UserProfile.html}?id=${user.id}|">
							<img class="userImg" th:src="${user.profileImage.encodedString}"/>
						</a>
					</div>
					<form id="ajaxForm" class="flex-grow-1" th:action="@{/comms/AppendPost.do}"
						  enctype="multipart/form-data" method="post" th:object="${ topicSearchForm }">
						<p class="fw-bold mb-2" th:text="${user.username}">ログインユーザーの名前</p>
						<input type="hidden" th:value="${topic.topicNo}" id="topicNo" />
						<input type="hidden" th:value="${topic.subject}" id="subject" />
						<textarea rows="2" class="form-control" id="postText"></textarea>
						<!-- 画像のアップロード -->
						<div class="view_box">
						  <input type="file" id="postImg" class="file">
						</div>						
           				<!-- 
						<input type="file" id="postImg" class="file">
						<input type="file" id="postImg" />
						 -->
						<div th:if="${validationMessage}">
							<span class="text-danger" th:text="${validationMessage}"></span>
						</div>
						<div class="text-end mt-3">
							<button type="button" class="btn btn-success btn-sm shadow-sm">投稿</button>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>
</body>
</html>